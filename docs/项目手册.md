# 内容自动发布系统 - 项目手册

> **版本**: v1.2.0
> **最后更新**: 2025-12-17
> **作者**: 开发团队

---

## 📋 目录

1. [项目概述](#1-项目概述)
2. [项目目标与愿景](#2-项目目标与愿景)
3. [系统架构](#3-系统架构)
4. [目录结构](#4-目录结构)
5. [核心模块详解](#5-核心模块详解)
6. [数据流程](#6-数据流程)
7. [使用指南](#7-使用指南)
8. [平台适配器开发指南](#8-平台适配器开发指南)
9. [今日头条发布流程详解](#9-今日头条发布流程详解)
10. [搜狐号发布流程详解](#10-搜狐号发布流程详解)
11. [已知问题与解决方案](#11-已知问题与解决方案)
12. [后续开发计划](#12-后续开发计划)

---

## 1. 项目概述

### 1.1 项目简介

**内容自动发布系统**是一个基于Python的桌面应用程序，用于将AI生成的文章批量发布到多个内容平台（如今日头条、搜狐号等）。

系统采用**Playwright浏览器自动化**技术，模拟人工操作流程，实现文章的自动发布。

### 1.2 核心特性

| 特性 | 说明 |
|-----|------|
| **多账号管理** | 支持同时管理多个平台的多个账号 |
| **动态添加账号** | 一键添加新账号，自动创建独立浏览器环境 |
| **账号昵称显示** | 登录后自动获取并显示平台昵称 |
| **多平台支持** | 目前支持今日头条、搜狐号，可扩展其他平台 |
| **批量发布** | 一次导入多篇文章，批量发布到多个账号 |
| **登录状态保持** | 浏览器Cookie自动保存，无需重复登录 |
| **模拟人工输入** | 逐字输入+2-5秒随机延迟，降低平台检测风险 |
| **可视化界面** | 基于PySide6的现代GUI界面 |

### 1.3 技术栈

```
┌─────────────────────────────────────────────────────────┐
│  GUI层        │ PySide6 (Qt6) - 桌面应用界面           │
├─────────────────────────────────────────────────────────┤
│  业务逻辑层    │ Python 3.12 - 任务调度、数据处理       │
├─────────────────────────────────────────────────────────┤
│  自动化层      │ Playwright - 浏览器自动化              │
├─────────────────────────────────────────────────────────┤
│  数据层        │ JSON配置 + Excel/CSV文章              │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 项目目标与愿景

### 2.1 核心目标

**解决的核心问题**：内容创作者（尤其是使用AI生成内容的创作者）需要将文章发布到多个平台，手动操作耗时且重复。

**目标用户**：
- 自媒体运营者
- 内容矩阵管理者
- 需要批量发布内容的个人或团队

### 2.2 预期效果

1. **效率提升**：将原本需要30分钟的手动发布流程缩短到5分钟
2. **多账号并行**：5个账号各发布10篇文章 = 50篇文章自动完成
3. **错误减少**：自动化流程避免人工复制粘贴的遗漏和错误
4. **时间释放**：用户可以在发布过程中处理其他事务

### 2.3 业务流程目标

```
用户准备阶段:
├── 1. 使用AI工具生成文章内容
├── 2. 整理成Excel/CSV格式（标题 + 正文）
└── 3. 准备封面图片（上传到平台素材库）

系统执行阶段:
├── 4. 导入文章到系统
├── 5. 配置每个账号发布数量
├── 6. 一键启动批量发布
└── 7. 系统自动完成所有发布任务

发布完成后:
├── 8. 查看发布结果统计
└── 9. 处理失败的任务（如有）
```

### 2.4 每个账号的发布循环

**发布数量配置**：

用户可以在GUI控制台的「发布配置」表格中，**自由设置每个账号的发布数量**，没有固定限制。

| 配置项 | 说明 |
|-------|------|
| **发布数量** | 用户在控制台通过数字输入框自定义每个账号的发布篇数 |
| **文章分配** | 系统按账号顺序依次分配文章 |

**示例场景**（3个头条账号 + 2个搜狐账号，用户自定义数量）：

```
今日头条-账号1 → 用户设置8篇  → 发布文章1-8
今日头条-账号2 → 用户设置5篇  → 发布文章9-13
今日头条-账号3 → 用户设置10篇 → 发布文章14-23
搜狐号-账号1   → 用户设置3篇  → 发布文章24-26
搜狐号-账号2   → 用户设置4篇  → 发布文章27-30
────────────────────────────────
总计: 30篇文章（根据用户配置）
```

---

## 3. 系统架构

### 3.1 整体架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         用户界面层                            │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                   MainWindow (PySide6)                 │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │  │
│  │  │ 账号列表  │  │ 任务配置  │  │ 文章列表  │            │  │
│  │  └──────────┘  └──────────┘  └──────────┘            │  │
│  │  ┌──────────────────────────────────────┐            │  │
│  │  │              运行日志                 │            │  │
│  │  └──────────────────────────────────────┘            │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                         业务逻辑层                            │
│  ┌────────────────┐    ┌────────────────┐                   │
│  │   Scheduler    │───▶│  ExcelReader   │                   │
│  │   任务调度器    │    │  文章读取器     │                   │
│  └────────────────┘    └────────────────┘                   │
│           │                                                  │
│           ▼                                                  │
│  ┌────────────────────────────────────────┐                 │
│  │            平台适配器层                  │                 │
│  │  ┌──────────────┐  ┌──────────────┐   │                 │
│  │  │ToutiaoAdapter│  │ SohuAdapter  │   │                 │
│  │  │  今日头条     │  │   搜狐号      │   │                 │
│  │  └──────────────┘  └──────────────┘   │                 │
│  └────────────────────────────────────────┘                 │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                        浏览器自动化层                          │
│  ┌────────────────────────────────────────────────────────┐  │


### 3.2 核心组件说明

| 组件 | 文件 | 职责 |
|-----|------|------|
| **MainWindow** | `src/ui/main_window.py` | GUI主窗口，用户交互入口 |
| **AsyncWorker** | `src/ui/main_window.py` | QThread工作线程，运行异步任务 |
| **Scheduler** | `src/core/scheduler.py` | 任务调度器，管理发布任务队列 |
| **BrowserManager** | `src/browser/browser_manager.py` | 浏览器管理器，管理Playwright实例 |
| **ToutiaoAdapter** | `src/adapters/toutiao_adapter.py` | 今日头条平台适配器 |
| **SohuAdapter** | `src/adapters/sohu_adapter.py` | 搜狐号平台适配器 |
| **ExcelReader** | `src/utils/excel_reader.py` | Excel/CSV文件读取器 |
| **Config** | `src/utils/config.py` | 配置管理，账号信息读写 |

---

## 4. 目录结构

```
内容自动发布/
├── 启动器.py                   # 程序入口（主启动文件）
├── main.py                     # 备用入口
├── requirements.txt            # Python依赖
├── README.md                   # 项目说明
├── docs/                       # 文档目录
│   └── 项目手册.md              # 本手册
│
├── src/                        # 源代码目录
│   ├── __init__.py
│   │
│   ├── adapters/               # 平台适配器
│   │   ├── __init__.py
│   │   ├── base_adapter.py     # 适配器基类（抽象类）
│   │   ├── toutiao_adapter.py  # 今日头条适配器
│   │   └── sohu_adapter.py     # 搜狐号适配器
│   │
│   ├── browser/                # 浏览器管理
│   │   ├── __init__.py
│   │   └── browser_manager.py  # Playwright浏览器管理器
│   │
│   ├── core/                   # 核心模块
│   │   ├── __init__.py
│   │   ├── logger.py           # 日志系统
│   │   └── scheduler.py        # 任务调度器
│   │
│   ├── ui/                     # 用户界面
│   │   ├── __init__.py
│   │   └── main_window.py      # 主窗口
│   │
│   └── utils/                  # 工具模块
│       ├── __init__.py
│       ├── config.py           # 配置管理（含动态添加账号）
│       └── excel_reader.py     # Excel/CSV读取
│
├── data/                       # 数据目录
│   ├── accounts.json           # 账号配置文件（含昵称信息）
│   ├── browser_profiles/       # 浏览器配置文件目录
│   │   ├── toutiao_account1/
│   │   │   └── storage_state.json  # ⭐ 登录状态（Cookie）保存位置
│   │   ├── toutiao_account2/
│   │   │   └── storage_state.json
│   │   ├── sohu_account1/
│   │   │   └── storage_state.json
│   │   └── ...                 # 动态添加的账号会自动创建目录
│   └── logs/                   # 日志文件
│       └── app_YYYYMMDD.log
│
└── 输入表格/                    # 用户存放Excel/CSV的目录（可选）
```

---

## 5. 核心模块详解

### 5.1 任务调度器 (Scheduler)

**文件**: `src/core/scheduler.py`

**职责**: 管理发布任务的生命周期

**核心数据结构**:

```python
@dataclass
class PublishTask:
    """发布任务"""
    account_id: str      # 账号ID
    account_name: str    # 账号名称
    platform: str        # 平台 (toutiao/sohu)
    article: Article     # 文章对象
    status: TaskStatus   # 任务状态
    result: Dict         # 发布结果

@dataclass
class AccountTask:
    """账号任务配置"""
    account_id: str
    account_name: str
    platform: str
    profile_dir: str
    publish_count: int = 0   # 该账号要发布的文章数
    enabled: bool = True
```

**核心方法**:

| 方法 | 说明 |
|-----|------|
| `load_accounts()` | 从配置文件加载账号列表 |
| `load_articles(file_path)` | 加载Excel/CSV文章 |
| `set_account_publish_count(account_id, count)` | 设置账号发布数量 |
| `generate_tasks()` | 根据配置生成任务队列 |
| `run()` | 异步执行所有任务 |
| `cancel()` | 取消任务执行 |
| `reset()` | 重置调度器状态 |
| `add_account(platform)` | **新增** 动态添加新账号 |

**任务执行流程**:

```
generate_tasks() 生成任务队列
       │
       ▼
run() 开始执行
       │
       ├── 遍历每个任务
       │   │
       │   ├── 获取/创建适配器
       │   │
       │   ├── check_login_status() 检查登录
       │   │   └── 未登录 → wait_for_login() 等待手动登录
       │   │
       │   ├── publish_article() 发布文章
       │   │
       │   └── 记录结果，更新进度
       │
       └── 输出统计结果
```

### 5.2 浏览器管理器 (BrowserManager)

**文件**: `src/browser/browser_manager.py`

**职责**: 管理Playwright浏览器实例和多个独立的浏览器上下文

**设计要点**:

1. **单例模式**: 全局只有一个`browser_manager`实例
2. **多上下文**: 每个账号使用独立的BrowserContext（隔离Cookie）
3. **状态持久化**: 登录状态保存到`storage_state.json`
4. **Event Loop感知**: 检测event loop变化，自动重新初始化

**核心方法**:

| 方法 | 说明 |
|-----|------|
| `initialize()` | 初始化Playwright |
| `get_context(account_id, profile_dir)` | 获取账号的浏览器上下文 |
| `get_page(account_id, profile_dir)` | 获取账号的页面 |
| `save_storage_state(account_id, profile_dir)` | 保存登录状态 |
| `close_all()` | 关闭所有资源 |

**浏览器上下文隔离**:

```
BrowserManager
    │
    ├── Browser (Chromium)
    │   │
    │   ├── Context: toutiao_1 ──▶ storage_state.json (Cookie)
    │   │   └── Page
    │   │
    │   ├── Context: toutiao_2 ──▶ storage_state.json (Cookie)
    │   │   └── Page
    │   │
    │   └── Context: sohu_1 ──▶ storage_state.json (Cookie)
    │       └── Page
    │
    └── 每个Context完全隔离，互不影响
```

### 5.3 平台适配器 (Adapter)

**基类**: `src/adapters/base_adapter.py`

**职责**: 封装特定平台的发布逻辑

**抽象方法** (子类必须实现):

| 方法 | 说明 |
|-----|------|
| `check_login_status()` | 检查当前页面是否已登录 |
| `wait_for_login()` | 打开登录页面，等待用户手动登录 |
| `publish_article(article)` | 执行文章发布流程 |

**辅助方法** (基类提供):

| 方法 | 说明 |
|-----|------|
| `get_page()` | 获取该账号的Page对象 |
| `random_delay(min, max)` | 随机延迟，模拟人工 |
| `type_like_human(page, selector, text)` | 逐字输入，模拟打字 |
| `save_login_state()` | 保存登录Cookie |
| `get_nickname()` | **新增** 获取账号昵称 |

---

## 6. 数据流程

### 6.1 数据格式

**账号配置 (data/accounts.json)**:

```json
{
  "accounts": [
    {
      "id": "toutiao_1",
      "platform": "toutiao",
      "name": "今日头条-账号1",
      "profile_dir": "toutiao_account1",
      "enabled": true,
      "nickname": "用户昵称"
    },
    {
      "id": "sohu_1",
      "platform": "sohu",
      "name": "搜狐-账号1",
      "profile_dir": "sohu_account1",
      "enabled": true,
      "nickname": "用户昵称"
    }
  ]
}
```

**字段说明**:

| 字段 | 说明 |
|-----|------|
| `id` | 账号唯一标识（如 toutiao_1, sohu_2） |
| `platform` | 平台类型（toutiao/sohu） |
| `name` | 账号显示名称 |
| `profile_dir` | 浏览器配置目录名 |
| `enabled` | 是否启用 |
| `nickname` | **新增** 登录后自动获取的平台昵称 |

**文章格式 (Excel/CSV)**:

| 列 | 说明 | 必填 |
|---|------|-----|
| A列 | 文章标题 | ✅ |
| B列 | 文章正文 | ✅ |
| C列 | 封面图片URL（暂未使用） | ❌ |

> **注意**: 第一行为标题行，从第二行开始读取数据

### 6.2 登录信息保存机制

**保存位置**：每个账号的登录信息（Cookie）保存在独立的目录中

```
data/browser_profiles/
├── toutiao_account1/
│   └── storage_state.json    ← 今日头条账号1的登录Cookie
├── toutiao_account2/
│   └── storage_state.json    ← 今日头条账号2的登录Cookie
├── sohu_account1/
│   └── storage_state.json    ← 搜狐号账号1的登录Cookie
└── ...
```

**storage_state.json 内容示例**：

```json
{
  "cookies": [
    {
      "name": "sessionid",
      "value": "xxx",
      "domain": ".toutiao.com",
      "path": "/",
      "expires": 1734567890,
      "httpOnly": true,
      "secure": true
    }
  ],
  "origins": []
}
```

**工作原理**：

1. **首次登录**：用户手动登录后，系统调用 `save_storage_state()` 保存Cookie
2. **后续使用**：系统启动时自动加载 `storage_state.json`，恢复登录状态
3. **Cookie过期**：如果Cookie过期，需要重新点击登录按钮手动登录

**注意事项**：

- ⚠️ `storage_state.json` 包含敏感信息，请勿分享给他人
- ⚠️ 如果登录失效，删除对应的 `storage_state.json` 文件后重新登录
- ⚠️ 不同电脑使用同一账号需要重新登录

### 6.3 文章分配逻辑

系统按照**顺序分配**文章给各账号：

```
假设有42篇文章，配置如下：
- 账号1: 发布10篇
- 账号2: 发布10篇
- 账号3: 发布10篇

分配结果：
- 账号1: 文章1-10
- 账号2: 文章11-20
- 账号3: 文章21-30
```

---

## 7. 使用指南

### 7.1 环境准备

**1. 安装Python 3.12+**

**2. 安装依赖**:
```bash
pip install -r requirements.txt
```

**3. 安装Playwright浏览器**:
```bash
playwright install chromium
```

### 7.2 配置账号

**方式一：软件内添加（推荐）**

1. 运行程序后，在账号列表底部点击「➕ 增加头条账号」或「➕ 增加搜狐账号」
2. 系统自动创建账号配置和独立浏览器环境
3. 新账号出现在列表中，点击「登录」按钮完成登录
4. 登录成功后自动显示账号昵称

**方式二：手动配置**

编辑 `data/accounts.json`:

```json
{
  "accounts": [
    {
      "id": "toutiao_1",
      "platform": "toutiao",
      "name": "今日头条-账号1",
      "profile_dir": "toutiao_account1",
      "enabled": true
    }
  ]
}
```

> **注意**: 手动添加后需要在 `data/browser_profiles/` 下创建对应的目录

### 7.3 准备文章

1. 创建Excel或CSV文件
2. 第一行为标题行（会被跳过）
3. A列填写文章标题
4. B列填写文章正文

### 7.4 运行程序

```bash
python 启动器.py
```

### 7.5 操作流程

```
1. 启动程序，看到主界面
        │
        ▼
2. （可选）点击「➕ 增加头条账号」或「➕ 增加搜狐账号」添加新账号
        │
        ▼
3. 点击每个账号的「登录」按钮
   ├── 浏览器弹出，显示登录页面
   ├── 手动完成登录（扫码/密码）
   ├── 登录成功后按钮变为「已登录 ✓」
   └── 自动获取并显示账号昵称
        │
        ▼
4. 点击「📂 导入Excel表格」
   └── 选择包含文章的Excel/CSV文件
        │
        ▼
5. 在「发布配置」表格中设置每个账号的发布数量
        │
        ▼
6. 点击「▶️ 开始发布」
   ├── 系统自动打开浏览器
   ├── 依次填写标题、正文（模拟人工逐字输入）
   ├── 选择封面（从素材库）
   ├── 每个操作间隔2-5秒随机等待
   └── 点击发布按钮
        │
        ▼
7. 等待所有任务完成
   └── 查看日志确认发布结果
```

---

## 8. 平台适配器开发指南

### 8.1 添加新平台适配器

**步骤1**: 创建适配器文件

```python
# src/adapters/new_platform_adapter.py

from src.adapters.base_adapter import BaseAdapter
from src.utils.excel_reader import Article

class NewPlatformAdapter(BaseAdapter):
    """新平台适配器"""

    PLATFORM_NAME = "new_platform"
    LOGIN_URL = "https://new-platform.com/login"
    PUBLISH_URL = "https://new-platform.com/publish"
    HOME_URL = "https://new-platform.com/"

    async def check_login_status(self) -> bool:
        """检查登录状态"""
        page = await self.get_page()
        await page.goto(self.HOME_URL, wait_until='domcontentloaded')

        # 根据页面元素判断是否已登录
        # 例如：检查是否有用户头像
        avatar = await page.query_selector('.user-avatar')
        return avatar is not None

    async def wait_for_login(self) -> bool:
        """等待用户手动登录"""
        page = await self.get_page()
        await page.goto(self.LOGIN_URL)

        # 轮询检查登录状态
        for _ in range(300):  # 最多等待5分钟
            if self._cancelled:
                return False
            if await self.check_login_status():
                await self.save_login_state()
                return True
            await asyncio.sleep(1)
        return False

    async def publish_article(self, article: Article) -> dict:
        """发布文章"""
        try:
            page = await self.get_page()
            await page.goto(self.PUBLISH_URL)
            await self.random_delay(1, 2)

            # 1. 输入标题
            await page.fill('.title-input', article.title)
            await self.random_delay(0.5, 1)

            # 2. 输入正文
            await page.fill('.content-editor', article.content)
            await self.random_delay(1, 2)

            # 3. 点击发布
            await page.click('.publish-button')
            await self.random_delay(2, 3)

            return {'success': True, 'message': '发布成功'}
        except Exception as e:
            return {'success': False, 'message': str(e)}
```

**步骤2**: 在调度器中注册适配器

编辑 `src/core/scheduler.py`，添加导入和创建逻辑。

**步骤3**: 在accounts.json中添加账号配置

```json
{
  "account_id": "new_platform_1",
  "account_name": "新平台-账号1",
  "platform": "new_platform",
  "profile_dir": "data/browser_profiles/new_platform_account1"
}
```

### 8.2 调试技巧

1. **使用浏览器开发者工具 (F12)** 获取元素选择器
2. **添加日志** `logger.info(...)` 跟踪执行流程
3. **截图调试** `await page.screenshot(path='debug.png')`
4. **设置 `headless=False`** 观察浏览器操作




---

## 9. 今日头条发布流程详解

### 9.1 页面URL

| 页面 | URL |
|-----|-----|
| 登录页 | `https://mp.toutiao.com/auth/page/login` |
| 首页 | `https://mp.toutiao.com/profile_v4/index` |
| 发布页 | `https://mp.toutiao.com/profile_v4/graphic/publish` |

### 9.2 元素选择器（ToutiaoSelectors类）

所有选择器定义在 `src/adapters/toutiao_adapter.py` 的 `ToutiaoSelectors` 类中：

| 选择器名称 | CSS选择器 | 用途 |
|-----------|----------|------|
| `TITLE_INPUT` | `textarea` | 标题输入框 |
| `CONTENT_EDITOR` | `.ProseMirror` | 正文编辑器（富文本） |
| `COVER_SELECT_AREA` | `.article-cover-images-wrap .article-cover-images > div > div > div > div` | 封面选择区域 |
| `MY_MATERIAL_TAB` | `.byte-drawer .byte-tabs-header-nav div > div > div > div:nth-child(4)` | "我的素材"标签页 |
| `MATERIAL_FIRST_IMAGE` | `.byte-drawer .ReactVirtualized__List > div > div > div > div:nth-child(1) > div > div > span.img-span` | 素材库第一张图片 |
| `MATERIAL_CONFIRM_BTN` | `.byte-drawer .footer button.byte-btn-primary > span` | 素材选择确定按钮 |
| `PUBLISH_BTN` | `#root button.publish-btn.publish-btn-last > span` | 预览并发布按钮 |
| `CONFIRM_PUBLISH_BTN` | `#root button.publish-btn.publish-btn-last > span` | 确认发布按钮 |

### 9.3 发布流程（模拟人工输入）

```
1. 打开发布页面
   └── goto(PUBLISH_URL)
        │
        ▼
2. 等待页面加载
   └── wait_for_selector('textarea')
   └── random_delay(2, 5) ← 随机等待2-5秒
        │
        ▼
3. 点击标题区域关闭弹窗
   └── click(标题输入框, force=True)
        │
        ▼
4. 清空并逐字输入标题 ← 模拟人工打字
   └── type(标题输入框, article.title, delay=50ms)
   └── random_delay(2, 5)
        │
        ▼
5. 分段逐字输入正文 ← 模拟人工打字
   ├── 按段落分割正文
   ├── 每段 type(正文编辑器, paragraph, delay=30ms)
   ├── 每段后按Enter换行
   └── 每5段额外休息1-2秒
   └── random_delay(2, 5)
        │
        ▼
6. 选择封面（从素材库）
   ├── click("选择封面")
   ├── click("我的素材")
   ├── click(第一张图片)
   └── click("确定")
        │
        ▼
7. 点击"预览并发布"
   └── random_delay(2, 5)
        │
        ▼
8. 点击"确认发布"
        │
        ▼
9. 等待发布完成
```

### 9.4 昵称获取

登录成功后，系统会自动访问用户主页获取昵称：

| 项目 | 值 |
|-----|-----|
| 主页URL | `https://mp.toutiao.com/profile_v4/index` |
| 昵称选择器 | `.auth-avator-name` |

---

## 10. 搜狐号发布流程详解

### 10.1 页面URL

| 页面 | URL |
|-----|-----|
| 登录页 | `https://mp.sohu.com/mpfe/v4/login` |
| 内容管理页 | `https://mp.sohu.com/mpfe/v4/contentManagement/first/page` |
| 发布页 | 点击"发布内容"按钮后进入 |

### 10.2 元素选择器（SohuSelectors类）

所有选择器定义在 `src/adapters/sohu_adapter.py` 的 `SohuSelectors` 类中：

| 选择器名称 | 用途 |
|-----------|------|
| `PUBLISH_CONTENT_BTN` | "发布内容"按钮 |
| `TITLE_INPUT` | 标题输入框 |
| `CONTENT_EDITOR` | 正文编辑器（Quill） |
| `COVER_UPLOAD_BTN` | 封面上传按钮 |
| `MATERIAL_TAB_SELECTORS` | 素材库标签（多选择器） |
| `MATERIAL_FIRST_IMAGE_SELECTORS` | 素材库第一张图片（多选择器） |
| `PUBLISH_BTN_SELECTORS` | 发布按钮（多选择器） |

### 10.3 发布流程

```
1. 打开内容管理页面
   └── goto(内容管理页URL)
        │
        ▼
2. 点击"发布内容"按钮
   └── click(PUBLISH_CONTENT_BTN)
        │
        ▼
3. 等待发布页面加载
   └── wait_for_selector(标题输入框)
   └── random_delay(2, 5)
        │
        ▼
4. 逐字输入标题
   └── type(标题输入框, article.title, delay=50ms)
   └── random_delay(2, 5)
        │
        ▼
5. 逐字输入正文
   └── type(正文编辑器, article.content, delay=30ms)
   └── random_delay(2, 5)
        │
        ▼
6. 选择封面（从素材库）
   ├── click(封面上传按钮)
   ├── click("素材库"标签) ← 使用文本定位
   ├── click(第一张图片)
   └── click("确定")
        │
        ▼
7. 点击发布按钮
   └── 多选择器策略，依次尝试
        │
        ▼
8. 等待发布完成
```

### 10.4 特殊处理

**多选择器策略**：搜狐号页面元素复杂，同一功能使用多个选择器备用：

```python
# 示例：素材库标签选择器
MATERIAL_TAB_SELECTORS = [
    ".el-dialog__wrapper.select-dialog .dialog-title h3.selected",
    ".el-dialog__wrapper.select-dialog .dialog-title h3:nth-child(2)",
    ".el-dialog__wrapper.select-dialog .dialog-title h3:last-child",
]
```

**Playwright文本定位**：使用 `page.get_by_text("素材库")` 精确定位

---

## 11. 已知问题与解决方案

### 10.1 Event Loop问题

**问题描述**: 登录任务和发布任务运行在不同的QThread中，每个QThread创建新的event loop。Playwright实例绑定到特定的event loop，loop变化后会出现问题。

**解决方案**: `BrowserManager.initialize()` 方法会检测event loop是否变化，如果变化则重新初始化Playwright，使用 `skip_cleanup=True` 避免尝试关闭旧loop中的资源。

### 10.2 停止按钮响应慢

**问题描述**: 点击停止按钮后，任务不会立即停止。

**解决方案**:
1. 在各个关键操作点添加 `_cancelled` 标志检查
2. `stop_publish()` 方法强制关闭浏览器，中断所有操作
3. 调用 `worker.terminate()` 终止工作线程

### 10.3 弹窗遮挡

**问题描述**: 今日头条页面有AI助手弹窗，会遮挡输入框。

**解决方案**:
1. 在填写内容前，先点击标题区域关闭弹窗
2. 使用 `force=True` 参数强制点击，即使有元素遮挡也能点击成功

### 10.4 登录与发布使用不同浏览器实例

**问题描述**: 登录任务完成后浏览器保持打开状态，发布时又打开新浏览器。

**解决方案**:
1. 登录成功后调用 `browser_manager.cleanup()` 关闭浏览器
2. 登录状态已保存到 `storage_state.json`，发布时会自动加载
3. 发布前调用 `browser_manager.reinitialize_for_new_loop()` 重新初始化

### 10.5 封面选择流程

**注意事项**:
1. 需要提前将封面图片上传到今日头条的"素材库"
2. 系统会自动选择素材库中的第一张图片作为封面
3. 如果素材库为空，封面选择会失败但不影响文章发布

---

## 12. 后续开发计划

### 12.1 已完成功能

- [x] 头条号文章发布
- [x] 搜狐号文章发布
- [x] 多账号管理
- [x] 动态添加账号功能
- [x] 账号昵称获取显示
- [x] 模拟人工输入（防检测）
- [x] 封面选择功能（素材库）
- [x] Cookie持久化登录

### 12.2 短期计划

- [ ] 账号删除功能
- [ ] 添加发布结果统计面板
- [ ] 支持文章定时发布
- [ ] 添加失败任务重试机制

### 12.3 中期计划

- [ ] 支持更多平台（百家号、微信公众号等）
- [ ] 支持图片自动上传
- [ ] 支持视频内容发布
- [ ] 添加代理IP支持

### 12.4 长期计划

- [ ] AI智能优化标题
- [ ] 发布效果数据分析
- [ ] 多机器分布式发布
- [ ] API接口供外部调用

---

## 附录

### A. 依赖版本

```
PySide6>=6.6.0       # GUI框架
playwright>=1.40.0   # 浏览器自动化
openpyxl>=3.1.2      # Excel读取
loguru>=0.7.2        # 日志增强
```

### B. 常见错误

| 错误 | 原因 | 解决方法 |
|-----|------|---------|
| `Timeout waiting for selector` | 元素未加载 | 增加等待时间或检查选择器 |
| `Browser closed` | 浏览器意外关闭 | 检查是否被手动关闭 |
| `Not logged in` | Cookie失效 | 重新登录账号 |

### C. 日志文件位置

```
data/logs/app_YYYYMMDD.log
```

---

**文档维护**: 请在修改代码后同步更新本手册，确保文档与代码一致。